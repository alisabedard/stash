#!/bin/sh
# Stash (C) 2015-2020 Jeffrey E. Bedard

# Very simple symlink-based package manager

# Set to your desired package location. Install packages in individual
# prefixes within this directory.

# Configure example for gettext:
# ./configure --prefix=/opt/gettext-0.20.1; make; make install

# Trace execution.
#set -x

# Set this to where you wish to install packages in individual directories.
STASH=/opt
# Set this to the destination directory where symlinks should be made.
DEST=/usr/local

get_items()
{
    PREV=$PWD # pushd/popd are bashisms
    SRC=$STASH/"$1"
    if [ -d "$SRC" ]; then
        cd "$SRC"
        find . | cut -d. -f2- | cut -d/ -f2-
        cd $PREV
    fi
}
uninstall_package()
{
    for ARG in $@; do
        for ITEM in `get_items "$ARG"`; do
            if [ -L $DEST/"$ITEM" ]; then
                rm $DEST/"$ITEM"
            fi
        done
    done
}
install_package()
{
    for ARG in $@; do
        for ITEM in `get_items "$ARG"`; do
            if [ -d $STASH/"$ITEM" ]; then
                mkdir -p $DEST/"$ITEM"
            else
                rm -f $DEST/"$ITEM" # Remove conflicts
                ln -s $STASH/$ARG/"$ITEM" $DEST/"$ITEM"
            fi
        done
    done
}
OPTSTRING="hlr:"
OPTIONS=`getopt -- $OPTSTRING "$@"` || exit 1
eval set -- "$OPTIONS"
while true; do
    case "$1" in
        -h) echo "stash -[$OPTSTRING]"; shift;;
        -l) ls $STASH; shift;;
        -r) uninstall_package $2; shift 2;;
        --) shift; install_package $@; break;;
    esac
done
